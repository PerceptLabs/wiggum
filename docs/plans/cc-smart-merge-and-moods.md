# CC Prompt: Smart CSS Merge + New Moods + Behavioral Nudges

> **Goal:** When Ralph writes to `src/index.css`, the shell should be smart — not adversarial. Instead of blocking or erroring, it preserves the generator's theme block, validates any color changes Ralph attempted, and appends Ralph's custom CSS. The tool understands intent and does the right thing. Additionally, expand mood coverage from 6 to 12 so Ralph finds a close match instead of freestyling. Finally, add behavioral nudges so Ralph actually uses the tokens system.

> **Principle:** The Wiggum Way — harness controls that cooperate, not fight. Ralph writes CSS naturally. The tool routes it correctly. No errors. No friction. Smart merge.

---

## WHY THIS EXISTS

Ralph ran `theme generate --seed 127 --pattern minimal --apply` which wrote WCAG-verified CSS variables + tokens.json. Then Ralph wrote `cat > src/index.css` with 6,582 bytes of hand-crafted CSS — completely replacing the generated theme. The result: tokens.json described a green palette that no longer existed on the page, contrast was unverified, and the entire design system was bypassed.

The old fix (write-guard blocks the write) is adversarial — Ralph gets an error, has to figure out the "right" way. The Wiggum fix: the tool understands what Ralph is doing (creative CSS with some theme overrides mixed in), separates concerns automatically, validates what needs validating, and succeeds with a helpful report.

---

## PART 1: Smart CSS Merge

### New file: `apps/ide/src/lib/shell/css-smart-merge.ts`

This file handles all the intelligence. ~120-150 lines.

#### Core function signature:

```typescript
export interface SmartMergeResult {
  content: string          // The merged CSS to write
  report: string           // Friendly stdout report for Ralph
  colorUpdates: Record<string, { l: number; c: number; h: number }>  // Changed colors for tokens sync
  fontsComment: string | null  // Extracted @fonts comment if present
}

export function smartMergeIndexCss(
  existingContent: string,
  incomingContent: string
): SmartMergeResult
```

#### Algorithm:

**Step 1 — Check for generator marker.**
If existing file does NOT contain `/* Generated by theme command`, this is a raw project. Do a plain write — return incoming content as-is, empty report, no color updates. Smart merge only activates when there's a generated theme to protect.

**Step 2 — Parse existing file into zones.**
The generated CSS has a known structure:
```
/* Generated by theme command — use theme modify to adjust */

:root { ... }          ← THEME ZONE (protected)
.dark { ... }          ← THEME ZONE (protected)
* { box-sizing... }    ← BASE RESET (protected)
body { margin... }     ← BASE RESET (protected)
                       ← CUSTOM ZONE (everything after body{})
```

Parse existing content into `themeZone` (marker through end of body{}) and `existingCustom` (everything after).

**Step 3 — Parse Ralph's incoming content.**

Extract three things from Ralph's content:

a) **`@fonts` comment** — regex: `/\/\*\s*@fonts:\s*(.+?)\s*\*\//`. This is important — the preview system uses it to inject Google Fonts `<link>` tags. Extract it, we'll put it at the top of the merged file.

b) **Variable overrides** — Parse any `:root { }` and `.dark { }` blocks in Ralph's content. Extract `--key: value;` pairs into `Record<string, string>` for light and dark respectively. These are Ralph's attempted theme variable changes.

c) **Custom CSS** — Everything in Ralph's content that is NOT inside `:root {}`, `.dark {}`, `* {}`, or `body {}` blocks, and is not the @fonts comment. This includes: keyframe animations, utility classes, custom selectors, media queries, etc.

**Step 4 — Validate and apply variable overrides.**

Walk the existing theme zone line by line. For each `--var: value;` line:

- Check if Ralph's overrides include this var
- If no override → keep existing line unchanged
- If Ralph provided an override:
  - **Color vars** (value contains `oklch(`): Parse both Ralph's value and existing value with `parseOklch()`. Look up the contrast pair for this var (use CONTRAST_PAIRS constant — import from dtcg.ts or define locally). Compute contrast ratio. If ratio ≥ 4.5 (WCAG AA) → use Ralph's value. If ratio < 4.5 → keep existing, add to `failedOverrides` list for reporting.
  - **Non-color vars** (fonts, radius, tracking, shadows, spacing): Accept Ralph's value directly. These don't have contrast constraints.
- Track all accepted color changes in `colorUpdates` for tokens.json sync.

Do the same for `.dark {}` block with Ralph's dark overrides.

**Important contrast validation detail:** Color vars come in pairs. When Ralph overrides `--primary`, check it against `--primary-foreground` (which may also be overridden by Ralph, or may be the existing value). The pairs from dtcg.ts CONTRAST_PAIRS:
```
foreground ↔ background
card-foreground ↔ card  
popover-foreground ↔ popover
primary-foreground ↔ primary
secondary-foreground ↔ secondary
muted-foreground ↔ muted
accent-foreground ↔ accent
destructive-foreground ↔ destructive
```
For sidebar pairs, same pattern. For chart colors and standalone vars (border, input, ring), no contrast check needed — accept Ralph's value.

**Step 5 — Assemble merged output.**

```
{fontsComment, if present}

{theme zone with validated overrides applied}

{existing custom CSS, if any}

{Ralph's new custom CSS}
```

If both existing and new custom CSS exist, separate with a blank line. Don't duplicate — if Ralph's custom CSS is identical to existing, skip.

**Step 6 — Build report string.**

```
Wrote src/index.css — preserved theme (52 vars), applied {N} overrides, appended custom CSS ({M} bytes)
```

If any contrast failures:
```
Wrote src/index.css — preserved theme (52 vars), applied {N} overrides (skipped {K}: contrast too low), appended custom CSS ({M} bytes)
⚠ Skipped overrides (WCAG AA contrast < 4.5:1):
  --primary: oklch(0.35 0.04 55) → ratio 3.2:1 against primary-foreground. Use: theme modify --shift-hue
  --accent: oklch(0.70 0.06 70) → ratio 3.8:1 against accent-foreground
```

If no overrides attempted (Ralph only wrote custom CSS):
```
Wrote src/index.css — preserved theme (52 vars), appended custom CSS ({M} bytes)
```

#### Imports needed:

```typescript
import { parseOklch, contrastRatio } from '../../theme-generator/oklch'
import type { OklchColor } from '../../theme-generator/types'
```

#### Helper functions in this file:

- `parseVarLines(block: string): Record<string, string>` — Extract `--key: value` pairs from a CSS block string
- `extractBlocks(css: string): { root: string | null, dark: string | null, custom: string }` — Split CSS into :root, .dark, and everything-else
- `extractFontsComment(css: string): string | null` — Find `/* @fonts: ... */`
- `isColorValue(value: string): boolean` — Check if value contains `oklch(`
- `findContrastPair(varName: string): string | null` — Given a fg var, return its bg pair (or vice versa)

#### Contrast pair lookup:

```typescript
const CONTRAST_PAIRS: [string, string][] = [
  ['foreground', 'background'],
  ['card-foreground', 'card'],
  ['popover-foreground', 'popover'],
  ['primary-foreground', 'primary'],
  ['secondary-foreground', 'secondary'],
  ['muted-foreground', 'muted'],
  ['accent-foreground', 'accent'],
  ['destructive-foreground', 'destructive'],
  ['sidebar-foreground', 'sidebar-background'],
  ['sidebar-primary-foreground', 'sidebar-primary'],
  ['sidebar-accent-foreground', 'sidebar-accent'],
]
```

This is the same list from dtcg.ts. Either import it (if exported) or duplicate it here. If duplicating, add a comment: `// Mirror of CONTRAST_PAIRS in dtcg.ts — keep in sync`.

---

### Modified file: `apps/ide/src/lib/shell/executor.ts`

Two methods need the smart merge intercept: `handleInternalWrite` and `handleRedirect`. Both follow the same pattern.

**In `handleInternalWrite`**, after the existing `validateFileWrite` and `validateFileContent` checks pass, BEFORE the actual `fs.writeFile`:

```typescript
// Smart merge for src/index.css — preserve generated theme, validate overrides, append custom CSS
if (filePath.endsWith('/src/index.css') || filePath.endsWith('\\src\\index.css')) {
  try {
    const existing = await this.fs.readFile(filePath, { encoding: 'utf8' }) as string
    if (existing.includes('/* Generated by theme command')) {
      const { smartMergeIndexCss } = await import('./css-smart-merge')
      const result = smartMergeIndexCss(existing, content)
      
      await this.fs.writeFile(filePath, result.content, { encoding: 'utf8' })
      fsEvents.fileChanged(filePath, 'modify')
      
      // Sync tokens.json if colors changed
      if (Object.keys(result.colorUpdates).length > 0) {
        try {
          const tokensPath = resolvePath(this.fs ? '/' : cwd, '.ralph/tokens.json')
          // Try both paths — cwd-relative and absolute
          const actualTokensPath = filePath.replace(/src\/index\.css$/, '.ralph/tokens.json')
          const tokensRaw = await this.fs.readFile(actualTokensPath, { encoding: 'utf8' }) as string
          const { patchDtcgColors } = await import('../../theme-generator')
          const tokens = JSON.parse(tokensRaw)
          patchDtcgColors(tokens, result.colorUpdates)
          await this.fs.writeFile(actualTokensPath, JSON.stringify(tokens, null, 2), { encoding: 'utf8' })
        } catch {
          // tokens.json doesn't exist or is invalid — skip silently
        }
      }
      
      return {
        exitCode: 0,
        stdout: result.report + '\n',
        stderr: '',
        filesChanged: [filePath],
      }
    }
  } catch {
    // File doesn't exist yet — fall through to normal write
  }
}
```

**In `handleRedirect`**, same pattern — after validation, before `fs.writeFile`, check if target is `src/index.css` with generator marker.

**Import** at top of executor.ts:
```typescript
// Dynamic import used inline — no top-level import needed for css-smart-merge
// (keeps executor light, smart merge only loaded when index.css is written)
```

Actually, use a dynamic `import()` inline to avoid loading smart merge code on every shell command. The import only triggers when `src/index.css` is the write target AND the file has a generator marker. This keeps executor.ts lean.

**NOTE on import paths:** The executor is at `src/lib/shell/executor.ts`. The theme-generator is at `src/lib/theme-generator/`. So the import path for `patchDtcgColors` from executor is `../../theme-generator`. The smart merge file is at `src/lib/shell/css-smart-merge.ts` — same directory as executor, so `./css-smart-merge`.

---

### NOT modified: `write-guard.ts`

No changes to write-guard. The smart merge approach replaces the need for blocking. write-guard continues to validate paths and content (blocking @tailwind directives, @import url(), HTML files, etc.) — it just doesn't need to know about theme zones.

---

## PART 2: Six New Moods

### Modified file: `apps/ide/src/lib/theme-generator/personalities.ts`

**Update `MoodName` type (line 10):**
```typescript
export type MoodName = 'minimal' | 'premium' | 'playful' | 'industrial' | 'organic' | 'editorial'
  | 'fashion-editorial' | 'brutalist' | 'zen' | 'corporate' | 'retro' | 'luxury'
```

**Update `MOOD_NAMES` array (line 23):**
```typescript
export const MOOD_NAMES: MoodName[] = [
  'minimal', 'premium', 'playful', 'industrial', 'organic', 'editorial',
  'fashion-editorial', 'brutalist', 'zen', 'corporate', 'retro', 'luxury',
]
```

**Add six new entries to `PERSONALITIES` record** (after the `editorial` entry, before the closing `}`):

Here are the personality definitions. Each follows the exact same `PersonalityBrief` interface as the existing 6.

#### `fashion-editorial`
```
philosophy: 'The runway on screen. Drama through restraint and scale.'
```
Key differentiators from `editorial`:
- Typography: Hero sizes go BIGGER (6xl-9xl), weight goes LIGHTER (200-300), tracking goes WIDER. This is fashion — scale IS the statement.
- Body text stays sans-serif (not serif like editorial) — clean, modern, fashion-magazine feel
- Animation: Slower, more theatrical. Scroll reveals at 600-900ms. Hover states are subtle opacity shifts, not transforms.
- Spacing: DRAMATIC section gaps (96-160px). Content breathes like a Vogue spread.
- Allowed: Full-bleed imagery placeholders, asymmetric layouts, overlapping type on background elements, extreme scale contrast between hero and body text, deconstructed typography (split words across lines)
- Not allowed: Rounded corners of any kind (radius: 0 always), bounce/spring animations, more than 2 colors beyond black/white/neutral, busy layouts, small hero text
- Checklist: Hero text is 6xl+ at light weight (200-300). Zero border-radius throughout. Section spacing is 6rem+. No more than 2 accent colors. Typography does the heavy lifting — minimal iconography.

#### `brutalist`
```
philosophy: 'Raw structure. No pretense. The code is the design.'
```
- Typography: Monospace throughout OR heavy sans-serif. Hero: bold (800-900), tight tracking. All-caps section labels.
- Animation: Minimal to none. If animation exists, it's instant (50-100ms) and mechanical (linear easing only).
- Spacing: Dense. Tight grid. No luxury whitespace — information density is the point.
- Allowed: Monospace fonts everywhere, visible grid lines and borders, high-contrast black/white, raw unprocessed aesthetic, system fonts, exposed structure (visible padding, explicit borders)
- Not allowed: Gradients, shadows of any kind, smooth easing curves, serif fonts, rounded corners, decorative elements, images as decoration
- Checklist: Uses monospace or heavy grotesque sans. Shadow profile: none. Radius: none. At least one section has visible border-grid structure. Colors: max 2 (typically black + one accent). No easing curves other than linear.

#### `zen`
```
philosophy: 'Emptiness is form. Let space speak.'
```
- Typography: Light weights (300-400) throughout. Hero sizes moderate (3xl-4xl) — zen doesn't shout. Body text is serif, unhurried.
- Animation: VERY slow. Scroll reveals at 800-1200ms. Easing: gentle ease-out curves. Everything fades, nothing bounces.
- Spacing: MAXIMUM whitespace. Section gaps: 120-200px. Card padding: 40-56px. Rhythm: expansive.
- Allowed: Single accent color (earth tones preferred), extreme whitespace, contemplative pacing, subtle border-bottom separators, natural imagery placeholders, organic shapes (if any)
- Not allowed: Bold weights above 500, more than 1 accent color, shadows heavier than subtle, fast animations under 400ms, dense layouts, uppercase text (too aggressive), decorative flourishes
- Checklist: Section spacing is 8rem+. Max font weight is 500. Animation minimum duration is 400ms. Color palette uses earth tones or cool neutrals. Overall impression: calm, spacious, contemplative.

#### `corporate`
```
philosophy: 'Clarity serves confidence. Systems enable trust.'
```
- Typography: Neo-grotesque sans throughout (no serif). Hero: semibold (600), tight tracking. Body: regular (400), comfortable size (base-lg). Everything readable, nothing flashy.
- Animation: Professional — present but restrained. 150-250ms transitions. No spring, no bounce. ease-out only.
- Spacing: Moderate, systematic. Grid-based. Consistent 4px rhythm. Nothing extreme in either direction.
- Allowed: Blue-gray palettes, structured grid layouts, data-visualization-friendly design, clear information hierarchy, professional iconography (outline style), card-based layouts
- Not allowed: Decorative fonts, spring/bounce easing, shadow profiles heavier than moderate, gradients on backgrounds, playful elements, asymmetric layouts
- Checklist: Single font family (sans-serif, no serif). Shadow profile: subtle or moderate. Information hierarchy is clear within 2 seconds. Layout is grid-aligned. Color palette is cool and professional. No animation exceeds 300ms.

#### `retro`
```
philosophy: 'Warmth with intention. Nostalgia refined, not replicated.'
```
- Typography: Mix of rounded sans and slab/serif. Hero: bold (700), normal tracking. Body: regular, warm and readable. Display type can be playful.
- Animation: Medium-speed. Hover states use scale + shadow lift. Transitions at 200-400ms with ease-out.
- Spacing: Comfortable, slightly generous. Not as tight as corporate, not as airy as zen. Cozy.
- Allowed: Warm color palettes (amber, ochre, cream, brown), rounded corners (moderate to rounded), visible shadows for depth, texture hints, mixed font families (slab + sans), vintage-inspired but not dated
- Not allowed: Neon colors, harsh shadows, minimal/flat design (needs some depth), cold blue palettes, extremely light font weights, brutalist aesthetics
- Checklist: Color palette feels warm (hue range 20-80). Border-radius is moderate to rounded. At least one shadow layer for depth. Fonts have personality but are readable. Overall impression: inviting, warm, tactile.

#### `luxury`
```
philosophy: 'Whisper, don''t shout. Exclusivity through absence.'
```
Key differentiators from `premium`:
- Typography: Even THINNER weights (200-300 at hero sizes). Tracking: wider than premium. Serif for display text — luxury leans into tradition.
- Animation: Extremely slow and controlled. Micro-interactions at 150ms but scroll reveals at 700-1000ms. Easing: custom cubic-bezier for silk-smooth feel.
- Spacing: More extreme than premium. Section gaps: 100-160px. Card padding: 40-56px. Everything has room to breathe.
- Allowed: Dark backgrounds with light text (inverted sections), gold/champagne accent tones, dramatic shadow profiles (for elevation, not harshness), thin horizontal rules as dividers, serif + thin sans pairing, letter-spacing as a design tool
- Not allowed: Bold weights above 500 at display sizes, more than 2 colors (excluding neutrals), playful or rounded elements, dense layouts, casual typography, visible borders (shadows for separation instead)
- Checklist: Display text weight ≤ 300. Letter-spacing is wide on hero/labels. At least one dark-bg inverted section. Shadow profile is dramatic (diffused). Section spacing is 6rem+. Overall impression: exclusive, refined, unhurried, effortless.

### Modified file: `apps/ide/src/lib/shell/commands/theme.ts`

**Update `PRESET_MOOD_MAP` (~line 41):**
Add mappings for existing presets that fit new moods better:
```typescript
const PRESET_MOOD_MAP: Record<string, MoodName> = {
  'northern-lights': 'organic',
  'cyberpunk': 'industrial',
  'doom-64': 'brutalist',        // ← changed from industrial (doom is raw, not factory)
  'retro-arcade': 'retro',       // ← changed from playful (retro fits better)
  'soft-pop': 'playful',
  'tangerine': 'playful',
  'mono': 'minimal',
  'elegant-luxury': 'luxury',    // ← changed from premium (luxury is now available)
  'bubblegum': 'playful',
  'mocha-mousse': 'zen',         // ← changed from organic (mocha is calm, contemplative)
  'caffeine': 'editorial',
  'catppuccin': 'minimal',
}
```

**Update `theme list moods` descriptions** (find the `descriptions` record in `handleList`):
```typescript
const descriptions: Record<MoodName, string> = {
  minimal: 'Let content breathe. Every element earns its place.',
  premium: 'Numbers are heroes, labels are whispers.',
  playful: 'Surprise at every scroll. Joy is not optional.',
  industrial: 'Raw materials. Visible structure. Nothing hidden.',
  organic: 'Natural rhythms. Flowing forms. Living systems.',
  editorial: 'The page is a stage. Typography performs.',
  'fashion-editorial': 'The runway on screen. Drama through restraint and scale.',
  brutalist: 'Raw structure. No pretense. The code is the design.',
  zen: 'Emptiness is form. Let space speak.',
  corporate: 'Clarity serves confidence. Systems enable trust.',
  retro: 'Warmth with intention. Nostalgia refined.',
  luxury: 'Whisper, don\'t shout. Exclusivity through absence.',
}
```

**Update usage string** — find the `private usage()` method. In the `--mood` description line, update the list of valid moods to include all 12.

---

## PART 3: Behavioral Nudges in loop.ts

### Modified file: `apps/ide/src/lib/ralph/loop.ts`

Two small additions:

**1. Add tokens.json to workspace file listing (~line 100-101):**

After the line about `.ralph/design-brief.md`, add:
```
- .ralph/tokens.json — Design system data (contrast ratios, shadow primitives, animation timing, typography scale). Run `tokens contrast` before choosing color pairings. Run `tokens` to check animation/font/shadow values. Don't guess — look it up.
```

**2. Enhance the polish check instruction (~line 201):**

Current text (approximately):
```
After gates pass, do ONE polish check: run `cat .ralph/snapshot/ui-report.md`, fix anything clearly broken, then mark complete.
```

Change to:
```
After gates pass, do ONE polish check: run `cat .ralph/snapshot/ui-report.md` and `tokens contrast`, fix any FAIL contrast pairs or clearly broken layout, then mark complete.
```

---

## PART 4: Issues Log Update

### Modified file: `docs/plans/issues-log.md`

Add to Open Issues:

```markdown
### TH-011: Pattern alias not transparent in theme output
**Source:** Log analysis (fashion magazine test run)
**Severity:** Low — cosmetic, no functional impact
**What happened:** Ralph typed `--pattern minimal`, output said `pattern=monochromatic` with no indication that `minimal` was an alias. Confusing for log readers.
**Where:** `apps/ide/src/lib/shell/commands/theme.ts` — generate/preset stdout messages
**Implementation:** Include alias in output: `"pattern=monochromatic (alias: minimal)"`. Check if the pattern name differs from the resolved pattern name — if so, append `(alias: {original})`.
**Scope:** ~3 lines in two places (preset path + generate path).
**Phase:** Nice-to-have
```

---

## TESTING

### Smart merge tests: `apps/ide/src/lib/shell/__tests__/css-smart-merge.test.ts`

Test cases:

1. **No generator marker** — incoming content written as-is, no merge
2. **Custom CSS only** — Ralph writes animations/utilities, no :root or .dark blocks. Theme zone preserved, custom CSS appended.
3. **Theme vars + custom CSS** — Ralph writes full file with :root{} + .dark{} + animations. Theme zone preserved with valid overrides applied. Custom CSS appended.
4. **Color override passes contrast** — Ralph overrides --primary with a value that has ≥ 4.5:1 contrast against --primary-foreground. Override accepted.
5. **Color override fails contrast** — Ralph overrides --primary with a value that has < 4.5:1 contrast. Existing value kept. Report mentions failure with ratio.
6. **Non-color override** — Ralph overrides --font-sans, --radius. Always accepted (no contrast constraint).
7. **@fonts comment preserved** — Ralph includes `/* @fonts: Playfair Display | DM Sans */`. Extracted and placed at top of merged file.
8. **Both fg and bg overridden** — Ralph overrides both --primary and --primary-foreground. Contrast checked between the TWO NEW values (not new vs old).
9. **Dark mode overrides** — Ralph includes .dark{} overrides. Applied independently from light overrides.
10. **Append mode (cat >>)** — Verify that `cat >> src/index.css` does NOT trigger smart merge (it's an append, not overwrite). Content appended normally.
11. **Existing custom CSS preserved** — File already has custom CSS below theme zone. New write adds more custom CSS. Both preserved, not duplicated.

### Mood tests: `apps/ide/src/lib/theme-generator/__tests__/personalities.test.ts`

If this file exists, add tests for:
1. All 12 mood names present in MOOD_NAMES array
2. All 12 moods have complete PersonalityBrief objects (all fields non-empty)
3. PERSONALITIES record has exactly 12 entries matching MoodName type
4. Each mood's checklist has at least 5 items
5. Each mood's typography array has at least 4 entries

### Integration test (manual verification):

After implementation, run this sequence in Wiggum:
```
theme generate --seed 55 --pattern minimal --mood fashion-editorial --apply
cat > src/index.css << 'EOF'
/* @fonts: Playfair Display:wght@200;300;400;700 | DM Sans:wght@300;400;500 */
:root {
  --font-sans: "DM Sans", ui-sans-serif, sans-serif;
  --font-serif: "Playfair Display", ui-serif, serif;
  --primary: oklch(0.35 0.04 55);
}
@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
.slash-divider::before {
  content: '///';
  color: var(--muted-foreground);
}
EOF
```

Expected output (approximately):
```
Wrote src/index.css — preserved theme (52 vars), applied 3 overrides (font-sans, font-serif, primary✓), appended custom CSS (247 bytes)
```

Then verify:
- `head -5 src/index.css` → shows @fonts comment at top, then generator marker
- `cat .ralph/tokens.json | grep primary` → shows updated primary color matching Ralph's override
- `tokens contrast` → shows all pairs passing (or specific failures if Ralph's --primary was bad)

---

## FILE CHANGE INDEX

| File | Action | Est. LOC |
|------|--------|----------|
| `src/lib/shell/css-smart-merge.ts` | CREATE | ~120-150 |
| `src/lib/shell/__tests__/css-smart-merge.test.ts` | CREATE | ~200 |
| `src/lib/shell/executor.ts` | EDIT | ~40 lines added (two intercept points) |
| `src/lib/theme-generator/personalities.ts` | EDIT | ~350 lines added (6 moods × ~55 lines each) |
| `src/lib/shell/commands/theme.ts` | EDIT | ~20 lines changed (PRESET_MOOD_MAP + descriptions + usage) |
| `src/lib/ralph/loop.ts` | EDIT | ~5 lines changed (2 behavioral nudges) |
| `docs/plans/issues-log.md` | EDIT | ~10 lines added (TH-011) |

**Total: 2 creates, 5 edits, ~750 LOC**

---

## VERIFICATION CHECKLIST

After all changes:

- [ ] `npm test` — all existing tests pass
- [ ] New smart merge tests pass (11 cases)
- [ ] `theme list moods` shows 12 moods with descriptions
- [ ] `theme generate --seed 55 --mood fashion-editorial --apply` works
- [ ] `theme generate --seed 55 --mood brutalist --apply` works
- [ ] `theme generate --seed 55 --mood zen --apply` works
- [ ] `cat > src/index.css` with custom CSS + theme vars triggers smart merge (not raw write)
- [ ] `cat >> src/index.css` with custom CSS does NOT trigger smart merge (normal append)
- [ ] Smart merge report shows in shell output
- [ ] tokens.json updated when color overrides accepted
- [ ] Contrast failure reported with specific ratios
- [ ] loop.ts system prompt mentions tokens.json in workspace section
- [ ] loop.ts polish check mentions `tokens contrast`
- [ ] issues-log.md has TH-011 entry

---

## KNOWN GAPS (future work)

- **sed -i on theme vars:** If Ralph uses `sed -i 's/--primary: .*/--primary: oklch(...)/' src/index.css`, the theme var changes without smart merge or tokens sync. This is an edge case — Ralph almost never uses sed to modify color values. Future fix: after sed writes to index.css, detect var changes and sync tokens.
- **replace on theme vars:** Same gap as sed. Low priority.
- **Pattern alias transparency (TH-011):** Output should show `pattern=monochromatic (alias: minimal)` when an alias resolves. One-line fix, not included in this prompt to keep scope focused.
